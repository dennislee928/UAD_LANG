# UAD Language Server (LSP)

åŸºæ–¼ Language Server Protocol (LSP) çš„ UAD èªè¨€ä¼ºæœå™¨å¯¦ä½œã€‚

## æ¶æ§‹

```
internal/lsp/
â”œâ”€â”€ server.go           # ä¸»ä¼ºæœå™¨ (JSON-RPC é€šè¨Š)
â”œâ”€â”€ documents.go        # æ–‡æª”ç®¡ç†
â”œâ”€â”€ analyzer.go         # ä»£ç¢¼åˆ†æ
â”œâ”€â”€ protocol/           # LSP å”è­°é¡å‹å®šç¾©
â”‚   â””â”€â”€ types.go
â”œâ”€â”€ analysis/           # æ·±åº¦åˆ†æ (TODO)
â”œâ”€â”€ completion/         # è‡ªå‹•è£œå…¨ (TODO)
â”œâ”€â”€ diagnostics/        # è¨ºæ–· (TODO)
â””â”€â”€ navigation/         # å°èˆª (TODO)
```

## å·²å¯¦ä½œåŠŸèƒ½

### âœ… Tier 1 åŸºç¤åŠŸèƒ½ï¼ˆéƒ¨åˆ†ï¼‰

1. **æ–‡æª”åŒæ­¥**:
   - `textDocument/didOpen`
   - `textDocument/didChange`
   - `textDocument/didClose`

2. **ç”Ÿå‘½é€±æœŸ**:
   - `initialize`
   - `initialized`
   - `shutdown`
   - `exit`

3. **åŸºç¤åˆ†æ**:
   - èªæ³•è§£æ
   - é¡å‹æª¢æŸ¥æ•´åˆ

### ğŸš§ é–‹ç™¼ä¸­

- è¨ºæ–·ç™¼å¸ƒ (`textDocument/publishDiagnostics`)
- è‡ªå‹•è£œå…¨ (`textDocument/completion`)
- æ‡¸åœæç¤º (`textDocument/hover`)

## ä½¿ç”¨æ–¹å¼

### å•Ÿå‹•ä¼ºæœå™¨

```bash
# æ§‹å»º
make build-lsp

# ä½¿ç”¨ stdio å‚³è¼¸ï¼ˆç”¨æ–¼ VS Code æ•´åˆï¼‰
./bin/uad-lsp -stdio

# å•Ÿç”¨æ—¥èªŒ
./bin/uad-lsp -stdio -log /tmp/uad-lsp.log

# æŸ¥çœ‹ç‰ˆæœ¬
./bin/uad-lsp -version
```

### èˆ‡ VS Code æ•´åˆ

ä¼ºæœå™¨æœƒè‡ªå‹•è¢« VS Code æ“´å±•å•Ÿå‹•ï¼ˆå¦‚æœ `uad.lsp.enable` ç‚º trueï¼‰ã€‚

é…ç½®è·¯å¾‘ï¼ˆVS Code settings.jsonï¼‰:

```json
{
  "uad.lsp.enable": true,
  "uad.lsp.serverPath": "uad-lsp"
}
```

## æ¸¬è©¦

### æ‰‹å‹•æ¸¬è©¦

1. å•Ÿå‹•ä¼ºæœå™¨ï¼š
```bash
./bin/uad-lsp -stdio -log /tmp/uad-lsp.log
```

2. ç™¼é€ initialize è«‹æ±‚ï¼ˆJSON-RPCï¼‰ï¼š
```json
{"jsonrpc":"2.0","id":1,"method":"initialize","params":{}}
```

3. æŸ¥çœ‹æ—¥èªŒï¼š
```bash
tail -f /tmp/uad-lsp.log
```

### èˆ‡ VS Code æ¸¬è©¦

1. æ‰“é–‹ `uad-vscode` ç›®éŒ„
2. æŒ‰ F5 å•Ÿå‹•æ“´å±•é–‹ç™¼ä¸»æ©Ÿ
3. æ‰“é–‹ `.uad` æ–‡ä»¶
4. æŸ¥çœ‹ Output é¢æ¿ â†’ "UAD Language Server"

## é–‹ç™¼è¨ˆåŠƒ

### éšæ®µ 1: åŸºç¤è¨­æ–½ âœ…

- [x] JSON-RPC é€šè¨Šå±¤
- [x] æ–‡æª”ç®¡ç†
- [x] åŸºç¤åˆ†ææ•´åˆ

### éšæ®µ 2: Tier 1 åŠŸèƒ½ (2-3 é€±)

- [ ] å®Œæ•´è¨ºæ–·å¯¦ä½œ
- [ ] éŒ¯èª¤ä½ç½®ç²¾ç¢ºæ˜ å°„
- [ ] åŸºç¤è£œå…¨ï¼ˆé—œéµå­—ï¼‰
- [ ] æ‡¸åœæç¤ºï¼ˆé¡å‹ä¿¡æ¯ï¼‰

### éšæ®µ 3: Tier 2 åŠŸèƒ½ (2-3 é€±)

- [ ] è·³è½‰å®šç¾©
- [ ] æŸ¥æ‰¾å¼•ç”¨
- [ ] ç¬¦è™Ÿæœç´¢

### éšæ®µ 4: Tier 3 åŠŸèƒ½ (2-3 é€±)

- [ ] ä»£ç¢¼æ ¼å¼åŒ–
- [ ] é‡å‘½å
- [ ] ä»£ç¢¼å‹•ä½œ

## æ¶æ§‹æ±ºç­–

### 1. JSON-RPC é€šè¨Š

ä½¿ç”¨æ¨™æº– JSON-RPC 2.0 over stdioï¼Œèˆ‡ VS Code å®Œå…¨å…¼å®¹ã€‚

### 2. æ–‡æª”ç®¡ç†

- æ‰€æœ‰æ‰“é–‹çš„æ–‡æª”ç·©å­˜åœ¨è¨˜æ†¶é«”ä¸­
- AST ç·©å­˜é¿å…é‡è¤‡è§£æ
- å¢é‡æ›´æ–°æ”¯æŒï¼ˆTODOï¼‰

### 3. åˆ†æç­–ç•¥

- æŒ‰éœ€åˆ†æï¼ˆdidChange æ™‚è§¸ç™¼ï¼‰
- éé˜»å¡åˆ†æï¼ˆgoroutineï¼‰
- çµæœç·©å­˜

### 4. éŒ¯èª¤è™•ç†

- å„ªé›…é™ç´šï¼ˆéƒ¨åˆ†åŠŸèƒ½å¤±æ•—ä¸å½±éŸ¿å…¶ä»–åŠŸèƒ½ï¼‰
- è©³ç´°æ—¥èªŒè¨˜éŒ„

## æ€§èƒ½è€ƒé‡

### ç•¶å‰ç‹€æ…‹

- æ¯æ¬¡æ–‡æª”è®Šæ›´éƒ½é‡æ–°è§£æï¼ˆç°¡å–®ä½†ä½æ•ˆï¼‰
- åŒæ­¥è™•ç†è«‹æ±‚ï¼ˆå¯èƒ½é˜»å¡ï¼‰

### å„ªåŒ–è¨ˆåŠƒ

1. **å¢é‡è§£æ**: åªé‡æ–°è§£æè®Šæ›´çš„éƒ¨åˆ†
2. **ä¸¦ç™¼è™•ç†**: Goroutine æ± è™•ç†è«‹æ±‚
3. **æ™ºèƒ½ç·©å­˜**: ASTã€é¡å‹ä¿¡æ¯ã€ç¬¦è™Ÿè¡¨
4. **å»¶é²è¨ˆç®—**: åªåœ¨éœ€è¦æ™‚è¨ˆç®—è¨ºæ–·

## æ•…éšœæ’é™¤

### å•é¡Œ: ä¼ºæœå™¨ç„¡æ³•å•Ÿå‹•

æª¢æŸ¥ï¼š
1. äºŒé€²åˆ¶æ–‡ä»¶æ˜¯å¦å­˜åœ¨ (`./bin/uad-lsp`)
2. PATH ç’°å¢ƒè®Šæ•¸
3. æ—¥èªŒæ–‡ä»¶æ¬Šé™

### å•é¡Œ: VS Code é€£æ¥å¤±æ•—

æª¢æŸ¥ï¼š
1. ä¼ºæœå™¨è·¯å¾‘é…ç½® (`uad.lsp.serverPath`)
2. æ“´å±•æ˜¯å¦å•Ÿç”¨ (`uad.lsp.enable`)
3. æŸ¥çœ‹ VS Code è¼¸å‡ºé¢æ¿

### å•é¡Œ: è¨ºæ–·ä¸é¡¯ç¤º

ç•¶å‰å·²çŸ¥é™åˆ¶ï¼šè¨ºæ–·åŠŸèƒ½å°šæœªå®Œå…¨å¯¦ä½œã€‚

## åƒè€ƒè³‡æº

- [LSP Specification](https://microsoft.github.io/language-server-protocol/)
- [LSP å¯¦ä½œæŒ‡å—](https://microsoft.github.io/language-server-protocol/implementors/servers/)
- [gopls æºç¢¼](https://github.com/golang/tools/tree/master/gopls) (åƒè€ƒå¯¦ä½œ)

---

*æœ€å¾Œæ›´æ–°ï¼š2025-01-07*


